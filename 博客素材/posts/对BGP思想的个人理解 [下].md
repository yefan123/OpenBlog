 另一种解决方案是不在CE的中转路径上启动BGP，只CE间指定邻居。这种方案也会带来一个问题，即路由黑洞。路由黑洞指ping不通路由表里的目标网络的现象。通常当路由表中的某一个条目在非邻居AS中时，往往ping不通。原因如下：

       AS 200的中转路由器R3（无BGP）转发AS 100的某个路由条目给AS 300的BGP路由表，但自身路由表中却没有这个条目（不可达），因此R7 ping AS 100中的网段会失败。

![这里写图片描述](https://image-store.slidesharecdn.com/353fa7eb-1a3b-414f-bbef-12eacc3f7889-original.jpeg)


       可以用MPLS来解决这个问题，由于mpls技术很复杂需要另作文章，这里讲主要逻辑：标签匹配路由与标签交换，在AS 200中共享路由条目的标签（插入数据包），这样R3寻路时不用看路由表了。

       然而BGP最主要是用在ISP分站之间，或者说是互联网的骨干协议。每一个AS或者联邦可以看成是互联网的结点。

![这里写图片描述](http://s6.sinaimg.cn/large/00688cvOzy732jrg0mx45&690)

       每家ISP的BGP路由器都存有数十万条互联网的路由条目。通过类比IGP发现也是通过结点间交换路由更新信息而来。首先BGP需要知道所属AS的内部网段信息，这有两种途径：

       1.宣告网络。不一定要宣告直连网络，只要IGP路由表中有的都可以宣告。

       2.重分发。直接将IGP分发进BGP，一键到底比较方便。

       然后与邻居AS交换路由信息表即可。

       返回来谈谈BGP邻居的建立过程。命令行指定邻居地址后，路由器会查询路由表，找到这个地址后向它发送TCP连接，三次握手之后才开始发送与接收open消息（跨网段），之后完成建立。Open消息主要包括：router-id、认证口令、目的与源地址、跳数与AS号。

       因为程序员逻辑，对ebgp peer发送hello包的TTL值为1，因为ebgp peer一般都是直连，如果用直连接口地址的话没有问题；但如果想用对方的环回口作为peer地址则会出现问题：对方收到包后将其ttl值减1变成0后丢弃，不在转向自己的环回口，关系无法建立。Ebgp多跳命令由此产生，用于强制修改数据包ttl值（一般改为2）。

       又因为程序员逻辑，前面也说过，BGP认为下一跳是下一个AS，路由更新起源于AS外的话，跟新包的源地址保持为AS外的地址，当此CE发给他的ibgp peer后，peer认为下一跳在AS外不可达，又导致了中断。Ibgp下一跳命令由此产生：总是做在ibgp peer之间。

       BGP同步机制是一个无用的鸡肋（而且也默认关闭），旨在将BGP更新同步给内网所有路由器。但这样一来相当于所有路由器都启用了BGP，BGP还有什么意义呢？要知道企业内部路由器的性能是无法承受几十万条路由的。

       BGP的选路机制。BGP 11条选路策略中最常用的是第四条：选择穿越自治系统数量最少的路径，也就是AS的"跳数"……

——第一部完