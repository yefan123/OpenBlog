该图也适用于glbp。接下来实现网关备份的具体过程：

若这些PC的ip都在同一个子网内，那给这个子网分配一个网关备份组（组编号）将若干路由器（不同协议有数量限制）加入到这个组中给这个组分配唯一的一个虚拟ip（即该子网内随便一个主机号），系统给这个组自动分配一个虚拟mac（注：虚拟ip可以与路由器接口真实ip在同一子网，也可以是接口真实ip所在子网下再划分的子网的主机号~）。将每台PC的网关ip都手动设置成这个虚拟ip（因为在交换层“寻路”都是通过mac地址，PC解析这个ip时，备份组回复给它虚拟mac值，同时备份组告诉交换机这个虚拟mac指向active/master）（！！！二层交换机“寻路”依靠mac地址表中的三个条目：PC的mac，网关接口mac，邻居交换机接口mac），由此PC向外通讯都将数据帧中目的mac字段值写为该虚拟mac。

    Active/master有两种情况被取代。第一种情况：因备份网关的holdtime到期后接任；第二种情况：Active/master所追踪的对象“挂了”导致自降优先级至小于某台开启了抢占的备份机，于是被抢占。

    当然，这幅物理拓扑图可以按组划分为多幅逻辑图，即有多个子网多个备份组，一台PC只能加入一个组但一个网关可以加入到多个组中。！注：若网关是多层交换机则可以使用SVI（switch virtual interface），为每个vlan安排一个备份组，在SVI下设置ip。

---

---
！！补充实验：

问题描述：子网内只有一个多层交换机充当网关，要实现网关的链路冗余，即使用EC将连接多层交换机的两个接口捆绑在一起（路由器貌似做不到）。拓扑图：
![这里写图片描述](http://s12.sinaimg.cn/large/00688cvOzy73kxAVcvh9b&690)
这是用Packet Tracer模拟实验的截图，可以看出，子网中只有vlan1但出现了“环路”，其实是因为EC逃避了stp计算（注：EC只能在交换网中玩儿）。

---

---

GLBP。GLBP除了提供冗余还可以让组中所有成员共同承担流量的转发。它的具体思想如下：

前期与HSRP一样，将多个物理网关加入到一个备份组中。组中的成员都叫AVF（active virtual forwarder）（顾名思义，所有AVF都负责转发数据），其中某一个AVF还叫做AVG（active virtual gateway）（竞选而来）。该组有一个虚拟ip但有多个虚拟mac地址：AVG给每个AVF分配一个虚拟mac。当备份组对应的子网内的某个PC解析虚拟ip时，AVG返回其中的一个虚拟mac。

这里有一个简单易懂的循环负载分担算法：当收到一个个PC发来的arp时，AVG在自己的虚拟mac列表中按顺序循环的分发这些地址给PC，以保证每个AVF所负责的PC数量相同（或相差不超过一台）。

其实用HSRP或VRRP也能实现负载分担，方法是：将多个物理网关共同加入到多个组，每个组虚拟ip都属于同一个子网，物理网关在不同组有不同角色，为每个PC分配不同的网关ip（其实一个子网可以有多个网关，关键看给PC设置的网关ip，但一个PC只能有一个对应网关）。但这个方法配置工作量很大，因此才出现了GLBP。

！！！补充知识：

> 【1】      FHRP的配置都是在接口下（除了多层交换机的svi）。网关因此知道，这个接口连接的是该接口ip所在的子网。
> 
> 【2】      FHRP的认证机制是为了防止恶意网关加入到某个备份组中。和动态路由协议的认证原理相同，都是相互hello时自动进行的。
> 
> 【3】     当某vlan生成树的根桥与该vlan热备份组的active/master不是同一台多层交换机时，可能会产生次优路径（同理于没有备份组只有唯一网关的子网）。
> 
> 【4】      数据流量从互联网回来的时候，可能从active/master走也可能从备份网关走（假如它们都将子网宣告进路由协议）。

    以上就是FHRP机制原理详解。若发现遗漏或错误之处，还请自行纠正。欲求更多信息请登录思科官网查询。（www.cisco.com）