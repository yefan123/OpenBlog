前言：学思科技术我想说，浅尝辄止，不是天才千万别深钻。和我研究高等数学一样，越深入就会发现越多的问题与不合理之处。尤其对于IT界，算法的最终解释权还是掌握在老外手中，所以对于有些细节，我们"记住就好"。

       本文主要关于BGP的逻辑而不是具体实验，所以我就随便配了几幅图，大多还是文字哈。由于BGP太过复杂，本文只是第一部介绍作品，以后会有更新！

       BGP边界网关协议（Border Gateway Protocol）是互联网上很重要的一个高层协议，被广泛应用于运营商网络的自制系统之间，以及与园区网络之间，实现不同网络之间的"兼容"。

       网关（gateway）英文译作"门口"，就像海关一样，是整个系统通往外界的唯一出路（除非你是走私~）。在园区网中"网关"有不同的概念，网络也有不同层次之分。企业内部路由器可以作为本地介入网络（网段）的网关，而企业边界路由器可以作为整个自制网络的网关。

       BGP边界网关协议就是这么一个凌驾于园区网络之上，实现与外部交流的机制。

正因为BGP工作在IGP之上，本质的不同导致一些细节上的重要区别：

       1.IGP路由器邻居之间必须是直连网络；BGP邻居不一定。

       2.IGP邻居自动发现；BGP邻居手动指定。

       3.同一个进程号的IGP（如eigrp）网络是连续的，即任意两个eigrp路由器之间至少有一条拓扑路径上全是eigrp路由器；而BGP只用在边界路由器上。

       4.未启动eigrp的路由器不会转发eigrp消息（阻断eigrp网络）；而非BGP路由器被要求转发IGP的消息（正是这一点导致了路由黑洞，稍后说）。

       5.IGP可以实现负载均衡；BGP默认不会。

       除此之外，BGP与IGP之间是可以类比的！就像二维函数与三维函数之间的类比关系，这种不同网络层次的类比可以这样理解：

       1.扩散能力：路由条目都能扩散到整个网络

       2.一个BPG网络（联邦或互联网）是由若干个IGP网络组成。

       3.IGP路由器身后是一个交换网络，BGP路由器身后是整个企业网（园区网），而企业网是由若干个交换网组成。

       4.IGP网络中认为下一跳（或组成单元）是另一个路由器，BGP网络认为下一跳是下一个自制系统（正是这一点衍生出命令next-hop-self，稍后讲）。

       由于国家管控严格，规定企业网络必须依赖互联网服务提供商（运营商ISP）接入互联网（世界各国都如此），运营商是互联网的骨干网之一，也是最为我们所熟知的电信、移动和联通。因此BGP与ISP密切相关。

![这里写图片描述](http://s14.sinaimg.cn/large/00688cvOzy732jWMsr3bd&690)

       当企业网只连接了一家运营商时，不需要启用BGP，CE端（client edge）只要做一个缺省路由并推向内部路由器，PE端（provider edge）做一个静态路由指向企业就好了。这种方案称为单宿（single homed）或双宿（dual homed）。但大型公司总是采用多宿方案（multihomed），即连接到两家以上的运营商来提高冗余性。多宿解决方案中可以有多种内网配置方案，但大多数公司会采用这种方案：

       在每个CE之间的中转路径上全启动BGP，相互指定ibgp peer关系（并不是两两关联）。此时企业网（或者说每一个BGP路由器）成为互联网的一部分（连通性），然后任选一个BGP路由器通过底层动态路由协议将默认路由推向企业内部路由器，即default information originate这条命令。然后这个BGP路由器就会根据数据包的目的ip判断发给哪一个CE。（BGP也有默认信息源这条命令，旨在告诉其他AS，默认流量从我的AS走，但不实用）

       这时会出现一个问题，即BGP的防环机制阻隔路由跟新的转发。因为BGP没有DUAL算法的防环性，也没有SPF算法的上帝视角，只采用了最原始的水平分割（split horizon），即从一个ibgp peer收到的更新包不许转发给另一个ibgp peer（与rip的水平分割不太一样）。为解决水平分割带来的问题，一个叫路由反射器（Route Reflector，RR）的东西开发出来。

       AS内BGP路径上可以将某个或某几个路由器设置成RR，剩下的成为RR的客户机（但并不知道自己是客户机）。说白了就是手动设置哪些路由器能转发从ibgp peer发来的更新包。

![这里写图片描述](http://s8.sinaimg.cn/large/00688cvOzy732jqRGnR07&690)